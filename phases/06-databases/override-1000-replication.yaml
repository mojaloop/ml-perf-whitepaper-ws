# Database values for Mojaloop Performance Testing
# This file configures MySQL and Kafka with proper node placement

## Global settings to allow bitnamilegacy images
global:
  security:
    allowInsecureImages: true

kafka:
  enabled: true
  fullnameOverride: "kafka"

  # Only use the Kafka nodes
  nodeSelector:
    workload-class.mojaloop.io/KAFKA-DATA-PLANE: "true"

  # Spread across sw1-kafka-n1 and sw1-kafka-n2
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - kafka
            topologyKey: kubernetes.io/hostname

  tolerations:
    - key: "dedicated"
      operator: "Equal"
      value: "kafka"
      effect: "NoSchedule"

  image:
    registry: docker.io
    repository: bitnamilegacy/kafka
    tag: "3.8.1-debian-12-r0"

  service:
    ports:
      client: 9092
      controller: 9093

  listeners:
    client:
      protocol: PLAINTEXT
    controller:
      protocol: PLAINTEXT
    interbroker:
      protocol: PLAINTEXT

    # Init container to fix permissions on /bitnami/kafka
  volumePermissions:
    enabled: true
    image:
      registry: docker.io
      repository: bitnamilegacy/os-shell
      tag: "12-debian-12-r51"
    resourcesPreset: "none" 

  metrics:
    kafka:
      enabled: false

  # ----------------------------------------------------
  # CONTROLLER (KRaft) - also acts as BROKER
  # 2 replicas, 1 per Kafka node
  # ----------------------------------------------------
  controller:
    replicaCount: 2

    persistence:
      enabled: true
      size: 100Gi
      # IMPORTANT: we'll define this StorageClass to pin PVs
      # to sw1-kafka-n1 / sw1-kafka-n2
      # storageClass: kafka-local-sc

    resources:
      requests:
        cpu: "12"
        memory: "32Gi"
      limits:
        cpu: "14"
        memory: "50Gi"

    nodeSelector:
      workload-class.mojaloop.io/KAFKA-DATA-PLANE: "true"

    tolerations:
      - key: "dedicated"
        operator: "Equal"
        value: "kafka"
        effect: "NoSchedule"

    overrideConfiguration: |
      ########################
      # Replication / Durability
      ########################
      default.replication.factor=2
      min.insync.replicas=1
      unclean.leader.election.enable=false
      auto.leader.rebalance.enable=true

      ########################
      # Topic Management
      ########################
      auto.create.topics.enable=true
      delete.topic.enable=true
      num.partitions=32

      ########################
      # Performance / Threading
      ########################
      num.network.threads=8
      num.io.threads=12
      num.replica.fetchers=2
      background.threads=4

      ########################
      # Socket Buffers
      ########################
      socket.send.buffer.bytes=10485760
      socket.receive.buffer.bytes=10485760
      socket.request.max.bytes=52428800
      message.max.bytes=10485760

      ########################
      # Log Configuration (persistent path)
      ########################
      log.dirs=/bitnami/kafka/data
      log.segment.bytes=268435456
      # log.flush.interval.messages=50000
      # log.flush.interval.ms=100
      log.retention.hours=1
      log.retention.bytes=2147483648
      log.cleanup.policy=delete
      log.cleaner.enable=false

      ########################
      # Controller / KRaft Settings
      ########################
      controlled.shutdown.enable=true
      offsets.topic.replication.factor=2
      transaction.state.log.replication.factor=2
      transaction.state.log.min.isr=1

      ########################
      # Request Handling / Queues
      ########################
      queued.max.requests=5000
      num.recovery.threads.per.data.dir=1

      ########################
      # Replication Performance
      ########################
      replica.fetch.min.bytes=1
      replica.fetch.max.bytes=10485760
      replica.fetch.wait.max.ms=500
      fetch.max.bytes=104857600

      ########################
      # Load Testing Tweaks
      ########################
      group.initial.rebalance.delay.ms=0
      producer.purgatory.purge.interval.requests=500
      consumer.purgatory.purge.interval.requests=500
      compression.type=producer

      ########################
      # Controller quorum voters - 2 nodes, IDs 1 and 2
      ########################
      controller.quorum.voters=1@kafka-0.kafka-headless.mojaloop.svc.cluster.local:9093,2@kafka-1.kafka-headless.mojaloop.svc.cluster.local:9093

    extraEnvVars:
      - name: KAFKA_HEAP_OPTS
        value: "-Xms16g -Xmx16g"
      - name: KAFKA_JVM_PERFORMANCE_OPTS
        value: "-server -XX:+UseG1GC -XX:MaxGCPauseMillis=15 -XX:InitiatingHeapOccupancyPercent=30 -XX:+ExplicitGCInvokesConcurrent -XX:+ParallelRefProcEnabled -Djava.awt.headless=true"

      - name: KAFKA_LOG_RETENTION_MS
        value: "3600000"

      # Replication factors (RF=2)
      - name: KAFKA_DEFAULT_REPLICATION_FACTOR
        value: "2"
      - name: KAFKA_MIN_INSYNC_REPLICAS
        value: "1"
      - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
        value: "2"
      - name: KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR
        value: "2"
      - name: KAFKA_TRANSACTION_STATE_LOG_MIN_ISR
        value: "1"

      # Safety / topic management
      - name: KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE
        value: "false"
      - name: KAFKA_AUTO_CREATE_TOPICS_ENABLE
        value: "true"

      # Message sizes
      - name: KAFKA_MESSAGE_MAX_BYTES
        value: "10485760"

      # KRaft roles & listeners
      - name: KAFKA_CFG_PROCESS_ROLES
        value: "controller,broker"
      - name: KAFKA_CFG_CONTROLLER_LISTENER_NAMES
        value: "CONTROLLER"
      - name: KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP
        value: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
      - name: KAFKA_CFG_CONTROLLER_QUORUM_VOTERS
        value: "1@kafka-0.kafka-headless.mojaloop.svc.cluster.local:9093,2@kafka-1.kafka-headless.mojaloop.svc.cluster.local:9093"

  # Disable separate broker STS – we use controller+broker only
  broker:
    replicaCount: 0
    persistence:
      enabled: false

  zookeeper:
    enabled: false

  provisioning:
    enabled: true
    waitForKafka: true
    persistence:
      enabled: false

    topics:
      - name: topic-transfer-prepare
        partitions: 12
        replicationFactor: 2
      - name: topic-transfer-fulfil
        partitions: 12
        replicationFactor: 2
      - name: topic-quotes-post
        partitions: 12
        replicationFactor: 2
      - name: topic-quotes-put
        partitions: 12
        replicationFactor: 2
      - name: topic-transfer-position-batch
        partitions: 8
        replicationFactor: 2
      - name: topic-notification-event
        partitions: 18
        replicationFactor: 2
      - name: topic-transfer-position
        partitions: 1
        replicationFactor: 2
      - name: topic-transfer-get
        partitions: 1
        replicationFactor: 2
      - name: topic-admin-transfer
        partitions: 1
        replicationFactor: 2
      - name: topic-quotes-get
        partitions: 1
        replicationFactor: 2
      - name: topic-bulkquotes-post
        partitions: 1
        replicationFactor: 2
      - name: topic-bulkquotes-put
        partitions: 1
        replicationFactor: 2
      - name: topic-bulkquotes-get
        partitions: 1
        replicationFactor: 2
      - name: topic-bulk-prepare
        partitions: 1
        replicationFactor: 2
      - name: topic-bulk-fulfil
        partitions: 1
        replicationFactor: 2
      - name: topic-bulk-processing
        partitions: 1
        replicationFactor: 2
      - name: topic-bulk-get
        partitions: 1
        replicationFactor: 2
      - name: topic-fx-quotes-post
        partitions: 1
        replicationFactor: 2
      - name: topic-fx-quotes-put
        partitions: 1
        replicationFactor: 2
      - name: topic-fx-quotes-get
        partitions: 1
        replicationFactor: 2
## Reference: https://github.com/bitnamilegacy/charts/blob/main/bitnamilegacy/mysql/values.yaml
mysql:
  enabled: true
  architecture: replication
  volumePermissions:
    enabled: true
    image:
      registry: docker.io
      repository: bitnamilegacy/os-shell
      tag: "12-debian-12-r51"
    resourcesPreset: "none"     
  image:
    registry: docker.io
    repository: bitnamilegacy/mysql
    tag: "8.0.40-debian-12-r3"

  auth:
    rootPassword: "db_password"
    createDatabase: true
    database: mldb
    username: "mluser"
    password: "ml_password"

    replicationUser: replicator
    replicationPassword: "adf34a&*ggn3"   # MUST NOT BE EMPTY

  # -------------------------
  # PRIMARY → sw1-mysql-n1
  # -------------------------
  primary:
    persistence:
      enabled: true
      size: 50Gi
      #storageClass: local-path

    nodeSelector:
      kubernetes.io/hostname: sw1-mysql-n1

    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: workload-class.mojaloop.io/RDBMS-ALS-LIVE
              operator: In
              values: ["true"]
          - matchExpressions:
            - key: workload-class.mojaloop.io/RDBMS-CENTRAL-LEDGER-LIVE
              operator: In
              values: ["true"]

    tolerations:
      - key: "dedicated"
        operator: "Equal"
        value: "mysql"
        effect: "NoSchedule"

    resources:
      limits:
        cpu: "16"
        memory: 56Gi
        ephemeral-storage: 100Gi
      requests:
        cpu: "14"
        memory: 54Gi
        ephemeral-storage: 100Gi

    extraFlags: |
      --max_connections=5000
      --innodb_buffer_pool_size=40G
      --innodb_log_file_size=4G
      --innodb_log_buffer_size=256M
      --innodb_flush_log_at_trx_commit=2
      --sync_binlog=0
      --innodb_flush_method=O_DIRECT
      --innodb_io_capacity=2000
      --innodb_io_capacity_max=4000
      --innodb_read_io_threads=8
      --innodb_write_io_threads=8
      --innodb_thread_concurrency=0
      --thread_cache_size=100
      --table_open_cache=4000
      --table_definition_cache=4000
      --max_allowed_packet=256M
      --tmp_table_size=256M
      --max_heap_table_size=256M
      --sort_buffer_size=4M
      --read_buffer_size=2M
      --read_rnd_buffer_size=1M
      --join_buffer_size=4M
      --key_buffer_size=64M

      --binlog_format=ROW
      --log-bin=mysql-bin
      --binlog_row_image=MINIMAL
      --transaction_write_set_extraction=XXHASH64
      --binlog_transaction_dependency_tracking=WRITESET

      --slow_query_log=0
      --performance_schema=OFF
      --skip_name_resolve
      --default_authentication_plugin=mysql_native_password

  # -------------------------
  # SECONDARY → sw1-mysql-n2
  # -------------------------
  secondary:
    replicaCount: 1

    persistence:
      enabled: true
      size: 50Gi
      # #storageClass: local-path

    nodeSelector:
      kubernetes.io/hostname: sw1-mysql-n2

    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: workload-class.mojaloop.io/RDBMS-ALS-LIVE
              operator: In
              values: ["true"]
          - matchExpressions:
            - key: workload-class.mojaloop.io/RDBMS-CENTRAL-LEDGER-LIVE
              operator: In
              values: ["true"]

    tolerations:
      - key: "dedicated"
        operator: "Equal"
        value: "mysql"
        effect: "NoSchedule"

    resources:
      limits:
        cpu: "16"
        memory: 56Gi
        ephemeral-storage: 100Gi
      requests:
        cpu: "14"
        memory: 54Gi
        ephemeral-storage: 100Gi

    extraFlags: |
      --innodb_buffer_pool_size=32G
      --innodb_flush_log_at_trx_commit=2
      --sync_binlog=0
      --innodb_flush_method=O_DIRECT
      --innodb_log_file_size=4G
      --innodb_log_buffer_size=256M
      --innodb_io_capacity=2000
      --innodb_io_capacity_max=4000
      --innodb_read_io_threads=8
      --innodb_write_io_threads=8
      --slave_parallel_type=LOGICAL_CLOCK
      --slave_parallel_workers=16
      --slave_preserve_commit_order=1
      --relay_log_recovery=ON
      --read_only=1
      --super_read_only=1
      --log_slave_updates=0
      --max_connections=2000
      --thread_cache_size=100
      --table_open_cache=4000
      --table_definition_cache=4000
      --slow_query_log=0
      --performance_schema=OFF
      --skip_name_resolve
      --default_authentication_plugin=mysql_native_password

  ## Initialize databases
  initdbScripts:
    accountLookupInit.sh: |
      #!/bin/bash
      set -e
      # Skip init on replicas (secondary pods)
      if [[ "${MYSQL_REPLICATION_MODE:-}" == "slave" ]]; then
        echo "Replica node detected, skipping ACCOUNT_LOOKUP init"
        exit 0
      fi
      DB_NAME=$ACCOUNT_LOOKUP_DATABASE
      DB_USER=$ACCOUNT_LOOKUP_USER
      DB_PASS=$MYSQL_PASSWORD
      echo "******* Creating '$DB_NAME' DB with user '$DB_USER' *******"
      mysql -u root -p$MYSQL_ROOT_PASSWORD -e \
        "DROP DATABASE IF EXISTS $DB_NAME;
        CREATE DATABASE $DB_NAME;
        DROP USER IF EXISTS $DB_USER@'%';
        CREATE USER '$DB_USER'@'%' IDENTIFIED BY '$DB_PASS';
        GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'%';
        FLUSH PRIVILEGES;"
      echo "******* Database '$DB_NAME' config complete *******"

    centralLedgerInit.sh: |
      #!/bin/bash
      set -e
      if [[ "${MYSQL_REPLICATION_MODE:-}" == "slave" ]]; then
        echo "Replica node detected, skipping CENTRAL_LEDGER init"
        exit 0
      fi      
      DB_NAME=$CENTRAL_LEDGER_DATABASE
      DB_USER=$CENTRAL_LEDGER_USER
      DB_PASS=$MYSQL_PASSWORD
      echo "******* Creating '$DB_NAME' DB with user '$DB_USER' *******"
      mysql -u root -p$MYSQL_ROOT_PASSWORD -e \
        "DROP DATABASE IF EXISTS $DB_NAME;
        CREATE DATABASE $DB_NAME;
        DROP USER IF EXISTS $DB_USER@'%';
        CREATE USER '$DB_USER'@'%' IDENTIFIED BY '$DB_PASS';
        GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'%';
        FLUSH PRIVILEGES;"
      echo "******* Database '$DB_NAME' config complete *******"

    consentOracleInit.sh: |
      #!/bin/bash
      set -e
      if [[ "${MYSQL_REPLICATION_MODE:-}" == "slave" ]]; then
        echo "Replica node detected, skipping CONSENT_ORACLE init"
        exit 0
      fi      
      DB_NAME=$CONTENT_ORACLE_DATABASE
      DB_USER=$CONTENT_ORACLE_USER
      DB_PASS=$MYSQL_PASSWORD
      echo "******* Creating '$DB_NAME' DB with user '$DB_USER' *******"
      mysql -u root -p$MYSQL_ROOT_PASSWORD -e \
        "DROP DATABASE IF EXISTS $DB_NAME;
        CREATE DATABASE $DB_NAME;
        DROP USER IF EXISTS $DB_USER@'%';
        CREATE USER '$DB_USER'@'%' IDENTIFIED BY '$DB_PASS';
        GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'%';
        FLUSH PRIVILEGES;"
      echo "******* Database '$DB_NAME' config complete *******"

    msisdnOracleInit.sh: |
      #!/bin/bash
      set -e
      if [[ "${MYSQL_REPLICATION_MODE:-}" == "slave" ]]; then
        echo "Replica node detected, skipping ORACLE_MSISDN init"
        exit 0
      fi      
      DB_NAME=$MSISDN_ORACLE_DATABASE
      DB_USER=$MSISDN_ORACLE_USER
      DB_PASS=$MYSQL_PASSWORD
      echo "******* Creating '$DB_NAME' DB with user '$DB_USER' *******"
      mysql -u root -p$MYSQL_ROOT_PASSWORD -e \
        "DROP DATABASE IF EXISTS $DB_NAME;
        CREATE DATABASE $DB_NAME;
        DROP USER IF EXISTS $DB_USER@'%';
        CREATE USER '$DB_USER'@'%' IDENTIFIED BY '$DB_PASS';
        GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'%';
        FLUSH PRIVILEGES;"
      echo "******* Database '$DB_NAME' config complete *******"

    authSvcInit.sh: |-
      #!/bin/bash
      set -e
      if [[ "${MYSQL_REPLICATION_MODE:-}" == "slave" ]]; then
        echo "Replica node detected, skipping AUTH_SVC init"
        exit 0
      fi      
      DB_NAME=$AUTH_SVC_DATABASE
      DB_USER=$AUTH_SVC_USER
      DB_PASS=$MYSQL_PASSWORD
      echo "******* Creating '$DB_NAME' DB with user '$DB_USER' *******"
      mysql -u root -p$MYSQL_ROOT_PASSWORD -e \
        "DROP DATABASE IF EXISTS $DB_NAME;
        CREATE DATABASE $DB_NAME;
        DROP USER IF EXISTS $DB_USER@'%';
        CREATE USER '$DB_USER'@'%' IDENTIFIED BY '$DB_PASS';
        GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'%';
        FLUSH PRIVILEGES;"
      echo "******* Database '$DB_NAME' config complete *******"

## MongoDB Configuration with Metrics
cl-mongodb:
  enabled: true
  fullnameOverride: "cl-mongodb"

  # Override image to use current available version
  image:
    registry: docker.io
    repository: bitnamilegacy/mongodb
    tag: "7.0.15-debian-12-r0"

  auth:
    enabled: true
    rootUser: root
    rootPassword: "adminpass"
    usernames:
      - 'mojaloop'
    passwords:
      - 'password'
    databases:
      - 'mlos'

  # MongoDB metrics configuration
  metrics:
    enabled: true
    port: 9216
    # Override metrics exporter image
    image:
      registry: docker.io
      repository: bitnamilegacy/mongodb-exporter
      tag: "0.41.2-debian-12-r0"
    service:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9216"
        prometheus.io/path: "/metrics"
    resources:
      limits:
        memory: 128Mi
      requests:
        memory: 64Mi
        cpu: 50m

  # Pod annotations
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9216"
    prometheus.io/path: "/metrics"

  persistence:
    enabled: false

## TTK MongoDB with Metrics
ttk-mongodb:
  enabled: true
  fullnameOverride: "ttk-mongodb"

  # Override image to use current available version
  image:
    registry: docker.io
    repository: bitnamilegacy/mongodb
    tag: "7.0.15-debian-12-r0"

  auth:
    enabled: true
    rootUser: root
    rootPassword: "adminpass"
    usernames:
      - 'ttk'
    passwords:
      - 'ttk'
    databases:
      - 'ttk'

  # MongoDB metrics configuration
  metrics:
    enabled: true
    port: 9216
    # Override metrics exporter image
    image:
      registry: docker.io
      repository: bitnamilegacy/mongodb-exporter
      tag: "0.41.2-debian-12-r0"
    service:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9216"
        prometheus.io/path: "/metrics"
    resources:
      limits:
        memory: 128Mi
      requests:
        memory: 64Mi
        cpu: 50m

  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9216"
    prometheus.io/path: "/metrics"

  persistence:
    enabled: false

## Redis Configuration with Metrics
ttksims-redis:
  enabled: true
  architecture: standalone
  fullnameOverride: ttksims-redis

  # Override image to use current available version
  image:
    registry: docker.io
    repository: bitnamilegacy/redis
    tag: "7.4.1-debian-12-r0"

  auth:
    enabled: false

  # Redis metrics configuration
  metrics:
    enabled: false
    port: 9121
    # Override metrics exporter image
    image:
      registry: docker.io
      repository: bitnamilegacy/redis-exporter
      tag: "1.66.0-debian-12-r0"
    service:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9121"
        prometheus.io/path: "/metrics"
    resources:
      limits:
        memory: 128Mi
      requests:
        memory: 64Mi
        cpu: 50m

  master:
    persistence:
      enabled: false

    # Pod annotations
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "9121"
      prometheus.io/path: "/metrics"

## Auth Service Redis with Metrics
auth-svc-redis:
  enabled: true
  architecture: standalone
  fullnameOverride: auth-svc-redis

  # Override image to use current available version
  image:
    registry: docker.io
    repository: bitnamilegacy/redis
    tag: "7.4.1-debian-12-r0"

  auth:
    enabled: false

  # Redis metrics configuration
  metrics:
    enabled: false
    port: 9121
    # Override metrics exporter image
    image:
      registry: docker.io
      repository: bitnamilegacy/redis-exporter
      tag: "1.66.0-debian-12-r0"
    service:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9121"
        prometheus.io/path: "/metrics"
    resources:
      limits:
        memory: 128Mi
      requests:
        memory: 64Mi
        cpu: 50m

  master:
    persistence:
      enabled: false

    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "9121"
      prometheus.io/path: "/metrics"

## Proxy Cache Redis Cluster with Metrics
proxy-cache-redis:
  enabled: true
  usePassword: false
  fullnameOverride: proxy-cache-redis
  clusterDomain: cluster.local

  # Override image to use current available version
  image:
    registry: docker.io
    repository: bitnamilegacy/redis-cluster
    tag: "8.2.1-debian-12-r0"

  persistence:
    enabled: false

  cluster:
    init: true
    nodes: 6
    replicas: 1

  # Redis Cluster metrics configuration
  metrics:
    enabled: false
    port: 9121
    # Override metrics exporter image
    image:
      registry: docker.io
      repository: bitnamilegacy/redis-exporter
      tag: "1.66.0-debian-12-r0"
    service:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9121"
        prometheus.io/path: "/metrics"
    resources:
      limits:
        memory: 128Mi
      requests:
        memory: 64Mi
        cpu: 50m

  # Pod annotations for all cluster nodes
  redis:
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "9121"
      prometheus.io/path: "/metrics"