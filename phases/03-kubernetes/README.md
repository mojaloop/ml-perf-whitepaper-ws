# Phase 03: Kubernetes Platform Services

> **Purpose**: Deploy essential platform services on both clusters
> 
> **Time Required**: 1-2 hours
> 
> **Outcome**: Kubernetes clusters ready with Istio, monitoring, and security tools

## üéØ What You'll Deploy

### On Mojaloop Cluster
- **Istio Service Mesh**: mTLS and traffic management
- **Prometheus & Grafana**: Metrics and dashboards
- **Cert-Manager**: TLS certificate management
- **Longhorn**: Distributed storage
- **External-DNS**: Automatic DNS management

### On K6 Cluster
- **K6 Operator**: Test orchestration
- **Prometheus**: Metrics collection
- **Grafana**: K6 test dashboards

## üìã Pre-deployment Checks

```bash
# Verify infrastructure phase completed
../02-infrastructure/validate.sh

# Check cluster access
kubectl config use-context mojaloop
kubectl get nodes

kubectl config use-context k6
kubectl get nodes
```

## üöÄ Deploy Platform Services

### Quick Deployment

```bash
# Deploy to both clusters
./deploy.sh --all

# Or deploy to specific cluster
./deploy.sh --cluster mojaloop
./deploy.sh --cluster k6
```

### What Gets Deployed

<details>
<summary><strong>Mojaloop Cluster Services</strong></summary>

```yaml
# 1. Istio Service Mesh
istio-system:
  - istiod (control plane)
  - istio-ingressgateway
  - istio-egressgateway

# 2. Monitoring Stack
monitoring:
  - prometheus-server
  - prometheus-alertmanager
  - grafana
  - loki (logs)

# 3. Security & Certificates
cert-manager:
  - cert-manager
  - cert-manager-webhook
  - cert-manager-cainjector

# 4. Storage
longhorn-system:
  - longhorn-manager
  - longhorn-driver
  - longhorn-ui
```

</details>

<details>
<summary><strong>K6 Cluster Services</strong></summary>

```yaml
# 1. K6 Infrastructure
k6-operator:
  - k6-operator-controller
  - k6-operator-webhook

# 2. Monitoring
monitoring:
  - prometheus-server
  - grafana-k6
```

</details>

## üìä Deployment Progress

Watch deployment status:

```bash
# Real-time status
./monitor-deployment.sh

# Check specific namespace
kubectl get pods -n istio-system -w
kubectl get pods -n monitoring -w
```

Expected timeline:
- Istio: 5-7 minutes
- Monitoring: 3-5 minutes
- Cert-Manager: 2-3 minutes
- Longhorn: 5-7 minutes

## üîç Validation

```bash
# Automated validation
./validate.sh

# Manual checks
kubectl config use-context mojaloop
kubectl get pods --all-namespaces | grep -v Running | grep -v Completed

# Should see all pods in Running state
```

Expected validation output:
```
Platform Services Validation
===========================
MOJALOOP CLUSTER:
‚úÖ Istio: All components running
‚úÖ Prometheus: Scraping metrics
‚úÖ Grafana: Accessible at http://grafana.mojaloop
‚úÖ Cert-Manager: Issuer ready
‚úÖ Longhorn: Storage available

K6 CLUSTER:
‚úÖ K6 Operator: Ready
‚úÖ Prometheus: Configured
‚úÖ Grafana: Dashboards loaded

üéâ Platform services ready!
```

## üåê Access Services

### Grafana Dashboards

```bash
# Get Grafana URLs
./get-urls.sh

# Output:
Mojaloop Grafana: http://grafana.mojaloop.local
  Username: admin
  Password: <auto-generated>

K6 Grafana: http://grafana.k6.local
  Username: admin  
  Password: <auto-generated>

# Port-forward for local access
kubectl port-forward -n monitoring svc/grafana 3000:80
# Access at http://localhost:3000
```

### Verify Service Mesh

```bash
# Check Istio injection
kubectl label namespace default istio-injection=enabled

# Verify mTLS is enabled
kubectl get peerauthentication --all-namespaces
```

## üîß Troubleshooting

<details>
<summary><strong>Istio pods not starting</strong></summary>

```bash
# Check Istio installation
istioctl verify-install

# Common fix: Reinstall Istio
./rollback.sh --component istio
./deploy.sh --component istio
```

</details>

<details>
<summary><strong>Storage not provisioning</strong></summary>

```bash
# Check Longhorn status
kubectl -n longhorn-system get pods

# Access Longhorn UI
kubectl port-forward -n longhorn-system svc/longhorn-frontend 8080:80
# Visit http://localhost:8080
```

</details>

## üì¶ Installed Components

### Version Matrix

| Component | Version | Purpose |
|-----------|---------|----------|
| Istio | 1.19.3 | Service mesh for mTLS |
| Prometheus | 2.45.0 | Metrics collection |
| Grafana | 10.2.0 | Visualization |
| Cert-Manager | 1.13.1 | TLS certificates |
| Longhorn | 1.5.1 | Distributed storage |
| K6 Operator | 0.0.8 | Test orchestration |

## ‚úÖ Completion Checklist

- [ ] All platform services deployed
- [ ] No pods in Error or CrashLoop state
- [ ] Grafana accessible and showing metrics
- [ ] Istio injection working
- [ ] Storage classes available

## üöÄ Next Step

With platform services ready:

```bash
# Verify you can create a test pod with Istio
kubectl apply -f test-pod.yaml
kubectl exec test-pod -- curl -I http://httpbin.org/status/200

# Clean up
kubectl delete -f test-pod.yaml
```

Ready for Mojaloop? ‚Üí [Phase 04: Mojaloop Deployment](../04-mojaloop/)

---

<details>
<summary><strong>üìö Additional Resources</strong></summary>

- [Istio Configuration Guide](ISTIO.md)
- [Monitoring Setup](MONITORING.md)
- [Platform Architecture](ARCHITECTURE.md)
- [Security Hardening](SECURITY.md)

</details>